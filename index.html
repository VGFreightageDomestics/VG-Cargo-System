<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VG HRIS | Payroll v16.0</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #064e3b; --secondary: #334155; --accent: #10b981; --bg-light: #f0fdf4; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--primary); font-size: 0.9rem; }
        
        .wrapper { display: flex; width: 100%; }
        .sidebar { min-width: 240px; background: var(--primary); color: #fff; min-height: 100vh; }
        .sidebar .header { padding: 20px; background: rgba(0,0,0,0.2); text-align: center; }
        .sidebar a { padding: 15px 20px; display: block; color: #a7f3d0; text-decoration: none; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .sidebar a:hover, .sidebar a.active { background: var(--accent); color: #fff; padding-left: 25px; }
        
        #content { width: 100%; padding: 20px; overflow-x: hidden; }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .table-input { border: 1px solid #dee2e6; width: 100%; padding: 5px; border-radius: 4px; }
        .hidden { display: none !important; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 350px; }

        /* --- PRINT STYLES --- */
        #printArea { display: none; }
        
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible !important; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; background: white; z-index: 9999; display: block !important; }
            .no-print { display: none !important; }
            
            @page { size: A4 landscape; margin: 5mm; }

            /* PAYSLIP STYLE */
            .payslip-wrapper { display: flex; justify-content: space-between; width: 100%; border: 1px dashed #999; height: 135mm; margin-bottom: 10mm; page-break-inside: avoid; box-sizing: border-box; }
            .payslip-half { width: 49%; padding: 15px; box-sizing: border-box; font-family: 'Arial', sans-serif; font-size: 10px; display: flex; flex-direction: column; border: 1px solid #000; }
            .payslip-left { border-right: 1px dotted #000; }
            .ps-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
            .ps-title { font-weight: bold; font-size: 14px; text-transform: uppercase; }
            .ps-info { margin-bottom: 10px; font-size: 11px; }
            .ps-grid { display: flex; gap: 10px; flex-grow: 1; }
            .ps-col { flex: 1; }
            .ps-box { border: 1px solid #ccc; padding: 5px; height: 100%; }
            .ps-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #ddd; padding: 3px 0; }
            .ps-net { background: #eee; border: 2px solid #000; padding: 10px; text-align: center; font-weight: bold; font-size: 14px; margin-top: 10px; -webkit-print-color-adjust: exact; }
            .ps-footer { margin-top: 15px; font-size: 9px; font-style: italic; text-align: center; }
            .copy-tag { float: right; font-weight: bold; border: 1px solid #000; padding: 2px 4px; font-size: 8px; }

            /* SUMMARY STYLE */
            .rpt-header { text-align: center; margin-bottom: 20px; font-family: Arial, sans-serif; }
            .rpt-title { font-size: 20px; font-weight: bold; text-transform: uppercase; }
            .rpt-table { width: 100%; border-collapse: collapse; font-family: 'Arial', sans-serif; font-size: 10px; }
            .rpt-table th { background-color: #ddd !important; border: 1px solid #000; padding: 6px; text-align: center; -webkit-print-color-adjust: exact; }
            .rpt-table td { border: 1px solid #000; padding: 4px; }
            .rpt-total { font-weight: bold; background-color: #eee !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
    <div class="login-box text-center">
        <h3 class="fw-bold mb-3 text-success">VG HRIS</h3>
        <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
        <input type="password" id="loginPass" class="form-control mb-3" placeholder="Password">
        <button class="btn btn-success w-100" onclick="login()">LOGIN</button>
    </div>
</div>

<!-- APP -->
<div id="mainApp" class="wrapper hidden">
    <nav class="sidebar">
        <div class="header">
            <h5 class="m-0 fw-bold">VG Payroll v16</h5>
            <small class="text-white-50" id="userDisplay">...</small>
        </div>
        <ul class="list-unstyled">
            <li><a href="#" onclick="nav('dashboard')" id="nav-dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
            <li><a href="#" onclick="nav('employees')" id="nav-employees"><i class="fas fa-users"></i> Employees</a></li>
            <li><a href="#" onclick="nav('payroll')" id="nav-payroll"><i class="fas fa-calculator"></i> Batch Payroll</a></li>
            <li><a href="#" onclick="nav('history')" id="nav-history"><i class="fas fa-print"></i> History & Reports</a></li>
            <li><a href="#" onclick="nav('users')" id="nav-users"><i class="fas fa-user-shield"></i> User Mgmt</a></li>
            <li><a href="#" onclick="logout()" class="text-warning mt-5"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </nav>

    <div id="content">
        <!-- 1. DASHBOARD -->
        <div id="page-dashboard" class="page-section">
            <h4 class="fw-bold mb-3">Dashboard</h4>
            <div class="row g-3">
                <div class="col-md-3"><div class="card p-3 bg-primary text-white"><small>Employees</small><h2 class="fw-bold" id="dashCount">0</h2></div></div>
                <div class="col-md-3"><div class="card p-3 bg-success text-white"><small>Net Paid</small><h2 class="fw-bold" id="dashTotalNet">₱0.00</h2></div></div>
                <div class="col-md-3"><div class="card p-3 bg-warning text-dark"><small>Gross Pay</small><h2 class="fw-bold" id="dashTotalGross">₱0.00</h2></div></div>
                <div class="col-md-3"><div class="card p-3 bg-danger text-white"><small>Deductions</small><h2 class="fw-bold" id="dashTotalDed">₱0.00</h2></div></div>
            </div>
        </div>

        <!-- 2. EMPLOYEES -->
        <div id="page-employees" class="page-section hidden">
            <h4 class="fw-bold mb-3">Employee Management</h4>
            <div class="row">
                <div class="col-md-5">
                    <div class="card p-3">
                        <h6 class="fw-bold text-success">Add / Edit Employee</h6>
                        <input type="hidden" id="editEmpId"> 
                        <form onsubmit="event.preventDefault(); saveEmployee();">
                            <div class="row g-2">
                                <div class="col-4"><small>ID No.</small><input type="text" id="empID" class="form-control" required></div>
                                <div class="col-8"><small>Full Name</small><input type="text" id="empName" class="form-control" required></div>
                                
                                <div class="col-6"><small>Branch</small><input type="text" id="empBranch" class="form-control" required list="branchList"></div>
                                <div class="col-6"><small>Position</small><input type="text" id="empPos" class="form-control" required></div>
                                
                                <div class="col-6"><small>Rate (₱)</small><input type="number" id="empRate" class="form-control" step="0.01" required></div>
                                <div class="col-6"><small>COLA</small><input type="number" id="empCola" class="form-control" value="0"></div>
                            </div>
                            
                            <div class="mt-2 bg-light p-2 rounded border">
                                <small class="fw-bold text-primary d-block mb-1">Fixed Deductions (2nd Cycle)</small>
                                <div class="row g-2">
                                    <div class="col-4"><input type="number" id="empSSSVal" class="form-control form-control-sm" placeholder="SSS"></div>
                                    <div class="col-4"><input type="number" id="empPhilVal" class="form-control form-control-sm" placeholder="PhilH"></div>
                                    <div class="col-4"><input type="number" id="empPagVal" class="form-control form-control-sm" placeholder="PagI"></div>
                                </div>
                            </div>

                            <div class="mt-2 text-muted small">Gov Numbers</div>
                            <input type="text" id="empSSS" class="form-control mb-1 form-control-sm" placeholder="SSS No.">
                            <input type="text" id="empPhil" class="form-control mb-1 form-control-sm" placeholder="PhilHealth No.">
                            <input type="text" id="empPag" class="form-control mb-1 form-control-sm" placeholder="Pag-IBIG No.">
                            
                            <div class="d-flex gap-2 mt-3">
                                <button type="submit" class="btn btn-success flex-grow-1" id="btnSaveEmp">Save</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelEdit()" id="btnCancelEdit" style="display:none;">Cancel</button>
                            </div>
                        </form>
                        <datalist id="branchList"><option value="Manila"><option value="Davao"><option value="Cebu"></datalist>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card p-0"><div class="table-responsive" style="max-height: 600px;"><table class="table table-hover mb-0"><thead class="table-light sticky-top"><tr><th>Name</th><th>Branch</th><th>Rate</th><th>Action</th></tr></thead><tbody id="empTableBody"></tbody></table></div></div>
                </div>
            </div>
        </div>

        <!-- 3. PAYROLL -->
        <div id="page-payroll" class="page-section hidden">
            <h4 class="fw-bold mb-3">Batch Payroll</h4>
            <div class="card p-3 mb-3 border-success">
                <div class="row g-2 align-items-end">
                    <div class="col-md-5">
                        <small class="fw-bold">Period</small>
                        <div class="input-group">
                            <input type="date" id="periodStart" class="form-control">
                            <span class="input-group-text">to</span>
                            <input type="date" id="periodEnd" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-2"><small class="fw-bold">Cycle</small><select id="batchCycle" class="form-select" onchange="toggleGovDed()"><option value="1">1st (No Gov)</option><option value="2">2nd (With Gov)</option></select></div>
                    <div class="col-md-3"><small class="fw-bold">Branch</small><select id="batchBranchFilter" class="form-select" onchange="loadPayrollTable()"><option value="All">All Branches</option></select></div>
                    <div class="col-md-2"><button class="btn btn-primary w-100 fw-bold" onclick="loadPayrollTable()">LOAD</button></div>
                </div>
            </div>
            <div class="card p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm align-middle mb-0" style="font-size: 0.8rem;">
                        <thead class="table-dark">
                            <tr>
                                <th width="15%">Name</th><th width="5%">Rate</th><th width="7%">Days</th><th width="7%">OT(Hr)</th>
                                <th width="8%">Holiday</th><th width="8%">GROSS</th><th width="7%">Late</th><th width="7%">SSS</th>
                                <th width="7%">PhilH</th><th width="7%">PagI</th><th width="7%">CA</th><th width="10%">NET PAY</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTableBody"><tr><td colspan="12" class="text-center p-3">Select dates and click LOAD</td></tr></tbody>
                    </table>
                </div>
                <div class="p-3 text-end bg-light">
                    <h4 class="d-inline me-3">Total: <span id="batchTotal">₱0.00</span></h4>
                    <button class="btn btn-success fw-bold" onclick="saveBatchPayroll()"><i class="fas fa-save"></i> SAVE BATCH</button>
                </div>
            </div>
        </div>

        <!-- 4. HISTORY & PRINT (FIXED DROPDOWN) -->
        <div id="page-history" class="page-section hidden">
            <h4 class="fw-bold mb-3">History & Reports</h4>
            <div class="row g-2 mb-3">
                <div class="col-md-5">
                    <label class="small">1. Select Period</label>
                    <select id="histPeriodFilter" class="form-select" onchange="loadRecordsByPeriod()">
                        <option value="">Select Period...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small">2. Filter Branch</label>
                    <select id="histBranchFilter" class="form-select" onchange="filterHistoryTable()">
                        <option value="All">All Branches</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex gap-2 align-items-end">
                    <button class="btn btn-warning fw-bold flex-grow-1" onclick="printFiltered('payslip')"><i class="fas fa-ticket-alt"></i> PAYSLIPS</button>
                    <button class="btn btn-secondary fw-bold flex-grow-1" onclick="printFiltered('summary')"><i class="fas fa-list"></i> SUMMARY</button>
                </div>
            </div>
            <div class="card"><div class="table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th>Name</th><th>Branch</th><th>Net Pay</th><th>Action</th></tr></thead><tbody id="historyTableBody"><tr><td colspan="4" class="text-center">Select a period above</td></tr></tbody></table></div></div>
        </div>
        
        <!-- 5. USERS -->
        <div id="page-users" class="page-section hidden">
            <div class="card p-4">
                <h4 class="fw-bold mb-3">User Management</h4>
                <div class="row g-3">
                    <div class="col-md-6">
                        <h6>Create User</h6>
                        <input type="email" id="newEmail" class="form-control mb-2" placeholder="Email"><input type="password" id="newPassword" class="form-control mb-2" placeholder="Password"><button class="btn btn-secondary" onclick="createStaffAccount()">Create Account</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- HOLIDAY MODAL -->
<div class="modal fade" id="holidayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title">Holiday Pay</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="holEmpId">
                <div class="mb-3"><label class="small fw-bold">Name/Date</label><input type="text" id="holDesc" class="form-control" placeholder="e.g. Feb 25 EDSA"></div>
                <div class="row g-2">
                    <div class="col-6"><label class="small">Type</label><select id="holType" class="form-select" onchange="calcHolidayPreview()"><option value="reg_work">Reg Worked (200%)</option><option value="reg_nowork">Reg Unworked (100%)</option><option value="spec_work">Spec Worked (130%)</option></select></div>
                    <div class="col-6"><label class="small">Days</label><input type="number" id="holDays" class="form-control" value="1" oninput="calcHolidayPreview()"></div>
                </div>
                <div class="alert alert-info mt-3">Add: <strong>₱<span id="holTotalAdd">0.00</span></strong></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="applyHolidayPay()">Apply</button></div>
        </div>
    </div>
</div>

<div id="printArea"></div>

<!-- FIREBASE -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, addDoc, collection, query, orderBy, where, getDocs, onSnapshot } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoijM1-8mNhcPb8KjcL_ZglJgoNdQLUrk",
      authDomain: "vg-payroll-system.firebaseapp.com",
      projectId: "vg-payroll-system",
      storageBucket: "vg-payroll-system.firebasestorage.app",
      messagingSenderId: "550694122065",
      appId: "1:550694122065:web:22f9bc8914349afddd3e70"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.db = db; window.auth = auth; window.doc = doc; window.setDoc = setDoc; window.updateDoc = updateDoc;
    window.addDoc = addDoc; window.collection = collection; window.query = query; window.orderBy = orderBy; 
    window.where = where; window.getDocs = getDocs; window.onSnapshot = onSnapshot;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword; window.signOut = signOut;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.initializeApp = initializeApp; window.deleteApp = deleteApp; window.firebaseConfig = firebaseConfig;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userDisplay').innerText = user.email;
            initApp();
        } else {
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginOverlay').classList.remove('hidden');
        }
    });
</script>

<script>
    let employees = [];
    let currentBatchData = [];
    const holidayModal = new bootstrap.Modal(document.getElementById('holidayModal'));

    async function login() {
        const e = document.getElementById('loginEmail').value; const p = document.getElementById('loginPass').value;
        try { await window.signInWithEmailAndPassword(window.auth, e, p); } catch(er) { alert(er.message); }
    }
    function logout() { window.signOut(window.auth); }
    function nav(p) {
        document.querySelectorAll('.page-section').forEach(d => d.classList.add('hidden'));
        document.getElementById(`page-${p}`).classList.remove('hidden');
    }

    function initApp() {
        // Load Employees
        const q = window.query(window.collection(window.db, "payroll_employees"), window.orderBy("name"));
        window.onSnapshot(q, (snap) => {
            employees = []; let branches = new Set(); let html = "";
            snap.forEach(doc => {
                let d = doc.data(); d.id = doc.id; employees.push(d); branches.add(d.branch);
                html += `<tr><td>${d.name}</td><td>${d.branch}</td><td>₱${d.dailyRate}</td><td><button class="btn btn-sm btn-primary" onclick="editEmp('${d.id}')">Edit</button></td></tr>`;
            });
            document.getElementById('empTableBody').innerHTML = html;
            document.getElementById('dashCount').innerText = employees.length;
            
            let bOpts = '<option value="All">All Branches</option>';
            branches.forEach(b => bOpts += `<option value="${b}">${b}</option>`);
            document.getElementById('batchBranchFilter').innerHTML = bOpts;
            document.getElementById('histBranchFilter').innerHTML = bOpts;
        });

        // Load Unique Periods (Batch History Fix)
        const qB = window.query(window.collection(window.db, "payroll_batches"), window.orderBy("timestamp", "desc"));
        window.onSnapshot(qB, (snap) => {
            let uniquePeriods = new Set();
            let opts = '<option value="">Select Period...</option>';
            snap.forEach(doc => {
                let d = doc.data();
                let label = `${d.periodName} (Cycle ${d.cycle})`;
                if (!uniquePeriods.has(label)) {
                    uniquePeriods.add(label);
                    // Value includes cycle to differentiate 1st/2nd half even if dates overlap
                    opts += `<option value="${d.periodName}">${label}</option>`;
                }
            });
            document.getElementById('histPeriodFilter').innerHTML = opts;
        });

        // Dashboard Stats
        const qRec = window.query(window.collection(window.db, "payroll_records"));
        window.onSnapshot(qRec, (snap) => {
            let tNet = 0, tGross = 0, tDed = 0;
            snap.forEach(doc => { let d=doc.data(); tNet+=parseFloat(d.netPay)||0; tGross+=parseFloat(d.gross)||0; tDed+=parseFloat(d.totalDed)||0; });
            document.getElementById('dashTotalNet').innerText = "₱"+tNet.toLocaleString(undefined,{minimumFractionDigits:2});
            document.getElementById('dashTotalGross').innerText = "₱"+tGross.toLocaleString(undefined,{minimumFractionDigits:2});
            document.getElementById('dashTotalDed').innerText = "₱"+tDed.toLocaleString(undefined,{minimumFractionDigits:2});
        });
    }

    // --- EMPLOYEE CRUD ---
    async function saveEmployee() {
        const id = document.getElementById('editEmpId').value;
        const d = {
            empID: document.getElementById('empID').value,
            name: document.getElementById('empName').value,
            branch: document.getElementById('empBranch').value,
            position: document.getElementById('empPos').value,
            dailyRate: parseFloat(document.getElementById('empRate').value),
            cola: parseFloat(document.getElementById('empCola').value) || 0,
            sssNo: document.getElementById('empSSS').value,
            philNo: document.getElementById('empPhil').value,
            pagNo: document.getElementById('empPag').value,
            sssAmount: parseFloat(document.getElementById('empSSSVal').value) || 0,
            philAmount: parseFloat(document.getElementById('empPhilVal').value) || 0,
            pagAmount: parseFloat(document.getElementById('empPagVal').value) || 0,
            timestamp: Date.now()
        };
        try {
            if (id) { await window.updateDoc(window.doc(window.db, "payroll_employees", id), d); alert("Updated!"); } 
            else { await window.addDoc(window.collection(window.db, "payroll_employees"), d); alert("Saved!"); }
            cancelEdit();
        } catch(e) { alert(e.message); }
    }

    function editEmp(id) {
        const e = employees.find(x => x.id === id); if(!e) return;
        document.getElementById('editEmpId').value = id;
        document.getElementById('empID').value = e.empID || '';
        document.getElementById('empName').value = e.name;
        document.getElementById('empBranch').value = e.branch;
        document.getElementById('empPos').value = e.position;
        document.getElementById('empRate').value = e.dailyRate;
        document.getElementById('empCola').value = e.cola || 0;
        document.getElementById('empSSS').value = e.sssNo || '';
        document.getElementById('empPhil').value = e.philNo || '';
        document.getElementById('empPag').value = e.pagNo || '';
        document.getElementById('empSSSVal').value = e.sssAmount || '';
        document.getElementById('empPhilVal').value = e.philAmount || '';
        document.getElementById('empPagVal').value = e.pagAmount || '';
        document.getElementById('btnSaveEmp').innerText = "Update Record";
        document.getElementById('btnSaveEmp').classList.replace('btn-success', 'btn-warning');
        document.getElementById('btnCancelEdit').style.display = 'block';
        window.scrollTo(0,0);
    }
    function cancelEdit(){ document.getElementById('editEmpId').value=""; document.querySelectorAll('#page-employees input').forEach(i=>i.value=""); document.getElementById('btnSaveEmp').innerText="Save Record"; document.getElementById('btnCancelEdit').style.display='none'; }

    // --- PAYROLL CALC ---
    function loadPayrollTable() {
        const filter = document.getElementById('batchBranchFilter').value;
        const cycle = document.getElementById('batchCycle').value;
        const list = filter === "All" ? employees : employees.filter(e => e.branch === filter);
        const govState = cycle === "1" ? "disabled style='background:#eee'" : "";
        let html = "";
        list.forEach(e => {
            let sssVal = (cycle === "2") ? (e.sssAmount || 0) : 0;
            let philVal = (cycle === "2") ? (e.philAmount || 0) : 0;
            let pagVal = (cycle === "2") ? (e.pagAmount || 0) : 0;
            html += `<tr class="pay-row" data-id="${e.id}" data-rate="${e.dailyRate}">
                <td><strong>${e.name}</strong><br><small class="text-muted">${e.position}</small></td>
                <td>${e.dailyRate}</td>
                <td><input type="number" class="table-input inp-days" oninput="calcRow(this)" placeholder="Days"></td>
                <td><input type="number" class="table-input inp-ot" oninput="calcRow(this)" placeholder="Hrs"></td>
                <td><div class="input-group input-group-sm"><input type="number" class="form-control inp-hol" oninput="calcRow(this)" value="0"><button class="btn btn-outline-secondary" onclick="openHolidayModal('${e.id}')"><i class="fas fa-calendar"></i></button></div><input type="hidden" class="inp-hol-desc"></td>
                <td class="fw-bold text-primary val-gross">0.00</td>
                <td><input type="number" class="table-input inp-late" oninput="calcRow(this)" value="0"></td>
                <td><input type="number" class="table-input inp-sss" oninput="calcRow(this)" value="${sssVal}" ${govState}></td>
                <td><input type="number" class="table-input inp-phil" oninput="calcRow(this)" value="${philVal}" ${govState}></td>
                <td><input type="number" class="table-input inp-pag" oninput="calcRow(this)" value="${pagVal}" ${govState}></td>
                <td><input type="number" class="table-input inp-ca" oninput="calcRow(this)" value="0"></td>
                <td class="fw-bold text-success val-net">0.00</td>
            </tr>`;
        });
        document.getElementById('payrollTableBody').innerHTML = html;
        document.querySelectorAll('.pay-row').forEach(row => calcRow(row.querySelector('.inp-days')));
        updateTotal();
    }
    function toggleGovDed() { loadPayrollTable(); }

    function calcRow(el) {
        if(!el) return;
        const row = el.closest('tr');
        const rate = parseFloat(row.dataset.rate);
        const hourly = rate / 8;
        const days = parseFloat(row.querySelector('.inp-days').value) || 0;
        const ot = parseFloat(row.querySelector('.inp-ot').value) || 0;
        const hol = parseFloat(row.querySelector('.inp-hol').value) || 0;
        
        const basic = days * rate;
        const otPay = ot * (hourly * 1.25);
        const gross = basic + otPay + hol;
        row.querySelector('.val-gross').innerText = gross.toFixed(2);

        const late = parseFloat(row.querySelector('.inp-late').value)||0;
        const sss = parseFloat(row.querySelector('.inp-sss').value)||0;
        const phil = parseFloat(row.querySelector('.inp-phil').value)||0;
        const pag = parseFloat(row.querySelector('.inp-pag').value)||0;
        const ca = parseFloat(row.querySelector('.inp-ca').value)||0;
        const totalDed = late + sss + phil + pag + ca;
        const net = gross - totalDed;
        row.querySelector('.val-net').innerText = net.toFixed(2);
        updateTotal();
    }
    function updateTotal() {
        let t = 0; document.querySelectorAll('.val-net').forEach(e => t += parseFloat(e.innerText));
        document.getElementById('batchTotal').innerText = "₱" + t.toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    function openHolidayModal(id) { document.getElementById('holEmpId').value = id; document.getElementById('holDesc').value = ""; calcHolidayPreview(); holidayModal.show(); }
    function calcHolidayPreview() { 
        const id=document.getElementById('holEmpId').value; const e=employees.find(x=>x.id===id); if(!e)return;
        const r=parseFloat(e.dailyRate); const t=document.getElementById('holType').value; const d=parseFloat(document.getElementById('holDays').value)||0;
        let add=0; if(t==='reg_work')add=r*1*d; if(t==='reg_nowork')add=r*1*d; if(t==='spec_work')add=r*0.3*d;
        document.getElementById('holTotalAdd').innerText=add.toFixed(2);
    }
    function applyHolidayPay() {
        const id=document.getElementById('holEmpId').value; const add=document.getElementById('holTotalAdd').innerText; const desc=document.getElementById('holDesc').value||"Holiday";
        const row=document.querySelector(`.pay-row[data-id="${id}"]`);
        if(row){ 
            const i=row.querySelector('.inp-hol'); const hd=row.querySelector('.inp-hol-desc');
            i.value=(parseFloat(i.value)+parseFloat(add)).toFixed(2);
            hd.value=hd.value?`${hd.value}, ${desc}`:desc;
            calcRow(i);
        }
        holidayModal.hide();
    }

    async function saveBatchPayroll() {
        const d1 = document.getElementById('periodStart').value; const d2 = document.getElementById('periodEnd').value;
        if(!d1 || !d2) return alert("Select Dates");
        const opts = { month: 'short', day: 'numeric', year: 'numeric' };
        const periodName = `${new Date(d1).toLocaleDateString('en-US', opts)} - ${new Date(d2).toLocaleDateString('en-US', opts)}`;
        const cycle = document.getElementById('batchCycle').value;
        if(!confirm(`Save Batch?`)) return;

        try {
            const ref = await window.addDoc(window.collection(window.db,"payroll_batches"),{periodName,cycle,timestamp:Date.now()});
            const rows = document.querySelectorAll('.pay-row');
            for(let row of rows){
                const net = parseFloat(row.querySelector('.val-net').innerText);
                if(net>0){
                    const e=employees.find(x=>x.id===row.dataset.id);
                    const gross = row.querySelector('.val-gross').innerText;
                    const totDed = (parseFloat(gross) - net).toFixed(2);
                    await window.addDoc(window.collection(window.db,"payroll_records"),{
                        batchId:ref.id, period:periodName, empName:e.name, branch:e.branch, position:e.position,
                        netPay:net, gross:gross, totalDed:totDed,
                        rate:e.dailyRate, days:row.querySelector('.inp-days').value,
                        ot:row.querySelector('.inp-ot').value, hol:row.querySelector('.inp-hol').value,
                        holDesc: row.querySelector('.inp-hol-desc').value,
                        late:row.querySelector('.inp-late').value, sss:row.querySelector('.inp-sss').value,
                        phil:row.querySelector('.inp-phil').value, pag:row.querySelector('.inp-pag').value, ca:row.querySelector('.inp-ca').value,
                        timestamp:Date.now()
                    });
                }
            }
            alert("Saved!"); document.getElementById('payrollTableBody').innerHTML="";
        } catch(e){alert(e.message);}
    }

    // --- HISTORY LOAD (UNIFIED FILTER) ---
    async function loadRecordsByPeriod() {
        const periodName = document.getElementById('histPeriodFilter').value;
        if(!periodName) return;
        const q = window.query(window.collection(window.db,"payroll_records"),window.where("period","==",periodName));
        const snap = await window.getDocs(q);
        currentBatchData=[]; 
        snap.forEach(doc=>{ let d=doc.data(); d.id=doc.id; currentBatchData.push(d); });
        filterHistoryTable();
    }

    function filterHistoryTable() {
        const branch = document.getElementById('histBranchFilter').value;
        const tableBody = document.getElementById('historyTableBody');
        let filtered = branch==="All" ? currentBatchData : currentBatchData.filter(d=>d.branch===branch);
        let html="";
        if(filtered.length===0){html="<tr><td colspan='4' class='text-center'>No records found</td></tr>";}
        else{
            filtered.forEach(d=>{ html+=`<tr><td>${d.empName}</td><td>${d.branch}</td><td>₱${d.netPay}</td><td><button class="btn btn-sm btn-info text-white" onclick="printOne('${d.id}')">Print</button></td></tr>`; });
        }
        tableBody.innerHTML=html;
    }

    function printFiltered(type) {
        const branch = document.getElementById('histBranchFilter').value;
        let data = branch==="All"?currentBatchData:currentBatchData.filter(x=>x.branch===branch);
        if(!data||data.length===0)return alert("No records");
        document.getElementById('printArea').innerHTML="";
        if(type==='payslip') generatePayslips(data); else generateSummary(data);
        setTimeout(()=>window.print(),1000);
    }
    
    function printOne(id){
        const d = currentBatchData.find(x=>x.id===id); generatePayslips([d]); setTimeout(()=>window.print(),1000);
    }

    function generatePayslips(data) {
        let html="";
        data.forEach(d=>{
            const half = (title) => `
            <div class="payslip-half ${title==='EMPLOYEE COPY'?'payslip-left':''}">
                <div class="ps-header">
                    <div class="ps-title">VG FREIGHTAGE DOMESTIC</div>
                    <div>Payslip: ${d.period}</div>
                </div>
                <div class="ps-info"><strong>${d.empName}</strong><br>${d.position} | ${d.branch}</div>
                <div class="ps-grid">
                    <div class="ps-col"><div class="ps-box"><strong>EARNINGS</strong>
                        <div class="ps-row"><span>Basic (${d.days}d)</span><span>${(d.days*d.rate).toFixed(2)}</span></div>
                        <div class="ps-row"><span>OT</span><span>${((d.rate/8)*1.25*d.ot).toFixed(2)}</span></div>
                        <div class="ps-row"><span>Holiday</span><span>${d.hol}</span></div><small>${d.holDesc||''}</small>
                        <div style="border-top:1px solid #000; font-weight:bold;"><span>GROSS</span> <span>${d.gross}</span></div>
                    </div></div>
                    <div class="ps-col"><div class="ps-box"><strong>DEDUCTIONS</strong>
                        <div class="ps-row"><span>Late</span><span>${d.late}</span></div>
                        <div class="ps-row"><span>SSS</span><span>${d.sss}</span></div>
                        <div class="ps-row"><span>PhilH</span><span>${d.phil}</span></div>
                        <div class="ps-row"><span>PagI</span><span>${d.pag}</span></div>
                        <div class="ps-row"><span>CA</span><span>${d.ca}</span></div>
                        <div style="border-top:1px solid #000; font-weight:bold;"><span>TOTAL</span> <span>${d.totalDed}</span></div>
                    </div></div>
                </div>
                <div class="ps-net">NET PAY: PHP ${parseFloat(d.netPay).toFixed(2)}</div>
                <div class="ps-footer">Received by: __________________________ <span class="copy-tag">${title}</span></div>
            </div>`;
            html += `<div class="payslip-wrapper">${half('EMPLOYEE COPY')}${half('COMPANY COPY')}</div>`;
        });
        document.getElementById('printArea').innerHTML=html;
    }

    function generateSummary(data) {
        let rows=""; let tNet=0;
        data.forEach(d=>{ tNet+=parseFloat(d.netPay); rows+=`<tr><td>${d.empName}</td><td>${d.position}</td><td>${d.gross}</td><td>${d.totalDed}</td><td>${d.netPay}</td></tr>`; });
        document.getElementById('printArea').innerHTML=`<div class="rpt-header"><div class="rpt-title">PAYROLL SUMMARY</div><div>${data[0].period} | ${document.getElementById('histBranchFilter').value}</div></div><table class="rpt-table"><thead><tr><th>Name</th><th>Pos</th><th>Gross</th><th>Ded</th><th>Net</th></tr></thead><tbody>${rows}</tbody><tfoot><tr class="rpt-total"><td colspan="4" align="right">TOTAL</td><td>${tNet.toFixed(2)}</td></tr></tfoot></table>`;
    }

    window.createStaffAccount = async function() { /*...*/ }
    window.setRole = async function(r) { /*...*/ }
    window.nav = nav; window.login = login; window.logout = logout; window.saveEmployee = saveEmployee; window.editEmp = editEmp; window.cancelEdit = cancelEdit; window.loadPayrollTable = loadPayrollTable; window.toggleGovDed = toggleGovDed; window.calcRow = calcRow; window.saveBatchPayroll = saveBatchPayroll; window.loadRecordsByPeriod = loadRecordsByPeriod; window.filterHistoryTable = filterHistoryTable; window.printFiltered = printFiltered; window.printOne = printOne;
    window.openHolidayModal = openHolidayModal; window.applyHolidayPay = applyHolidayPay; window.calcHolidayPreview = calcHolidayPreview;
</script>
</body>
</html>
